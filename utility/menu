#!/bin/bash
Green="\e[92;1m"
RED="\033[1;31m"
NC='\033[0m'
OR='\033[1;93m'
grenbo="\e[92;1m"

# فحص إذا كان الـ IP مسموح
ipsaya=$(wget -qO- ipinfo.io/ip)
data_ip="https://raw.githubusercontent.com/HumamArran/ScriptVps/main/ip"

# تحقق مستمر كل 2 ثانية
while true; do
    # تحميل البيانات من GitHub مع تحديث الكاش
    user_data=$(curl -H "Cache-Control: no-cache" -s "$data_ip" | grep "$ipsaya")

    if [[ -z "$user_data" ]]; then
       echo -e "${RED}✗ IP not found in the user database.${NC}"
       echo -e "${RED}✗ إذا أردت الاشتراك قم بالتواصل معنا على التليجرام: abuissac95@${NC}"
       exit 1
    fi

    # استخراج تاريخ انتهاء صلاحية المستخدم
    expiration_date=$(echo "$user_data" | awk '{print $2}')

    # الحصول على التاريخ الحالي
    current_date=$(date +"%Y-%m-%d")

    # مقارنة التاريخين
    if [[ "$current_date" > "$expiration_date" ]]; then
        echo -e "${RED}✗ Your IP has expired. Access denied.${NC}"
        exit 1
    else
        echo -e "${Green}✓ Your IP is valid until: $expiration_date${NC}"
    fi

    # أكمل السكربت كما هو
    data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
    date_list=$(date +"%Y-%m-%d" -d "$data_server")
    city=$(cat /etc/xray/city)
    NS=$(cat /etc/xray/dns)
    domain=$(cat /etc/xray/domain)
    isp=$(cat /etc/xray/isp | cut -d ' ' -f 1-2)

    RAM=$(free -m | awk 'NR==2 {print $2}')
    USAGERAM=$(free -m | awk 'NR==2 {print $3}')
    MODEL=$(cat /etc/os-release | grep -w PRETTY_NAME | head -n1 | sed 's/=//g' | sed 's/"//g' | sed 's/PRETTY_NAME//g' | cut -d '.' -f 1-3 )
    CORE=$(printf '%-1s' "$(grep -c cpu[0-9] /proc/stat)")
    versi=$(wget -qO- https://script.siglipanel.com/version)
    SERONLINE=$(uptime -p | cut -d " " -f 2-10000)

    # التحقق وإنشاء ملفات القواعد إن لم تكن موجودة
    for service in vmess vless trojan shadowsocks ssh; do
        mkdir -p /etc/$service
        touch /etc/$service/.$service.db
    done

    vm=$(grep -c "###" /etc/vmess/.vmess.db)
    vl=$(grep -c "###" /etc/vless/.vless.db)
    tr=$(grep -c "###" /etc/trojan/.trojan.db)
    ss=$(grep -c "###" /etc/shadowsocks/.shadowsocks.db)
    ssh=$(grep -c "###" /etc/ssh/.ssh.db)

    # ألوان إضافية
    magenta="\033[1;35m"
    green="\033[1;32m"
    white="\033[1;37m"
    blue="\033[1;34m"
    red="\033[1;31m"
    black="\033[1;40;30m"
    yellow="\033[1;33m"
    cyan="\033[1;36m"
    reset="\033[0m"
    bgyellow="\033[1;43;33m"
    bgwhite="\033[1;47;37m"
    bru="\033[0;36m"
    c0=${reset}; c1=${magenta}; c2=${green}; c3=${white}; c4=${blue}
    c5=${red}; c6=${yellow}; c7=${cyan}; c8=${black}; c9=${bgyellow}
    c10=${bgwhite}; c11=${bru}

    clear
    echo -e "  ${OR}──────────────────────────────────────${NC}"
    printf "\e[1;92m           .::::. \e[0m\e[1;77m MLAK  \e[1;92m.::::.\e[0m\n"
    echo -e "  ${OR}──────────────────────────────────────${NC}"
    echo -e "      ${OR}┌───────────────────────────┐${NC}"
    echo -e "      ${OR}│ ${NC}${RED}SYS OS :${NC} $MODEL"
    echo -e "      ${OR}│ ${NC}${RED}RAM :${NC} $RAM MB/$USAGERAM MB "
    echo -e "      ${OR}│ ${NC}${RED}UP :${NC} $SERONLINE"
    echo -e "      ${OR}│ ${NC}${RED}CORE :${NC} $CORE"
    echo -e "      ${OR}│ ${NC}${RED}ISP :${NC} $isp"
    echo -e "      ${OR}│ ${NC}${RED}CITY :${NC} $city"
    echo -e "      ${OR}│ ${NC}${RED}IP :${NC} $ipsaya"
    echo -e "      ${OR}│ ${NC}${RED}DOMAIN :${NC} $domain"
    echo -e "      ${OR}│ ${NC}${RED}NS :${NC} $NS"
    echo -e "      ${OR}└────────────────────────────┘${NC}"
    echo -e "           SSH OVPN: $ssh VMESS: $vm"
    echo -e "       VLESS: $vl TROJAN: $tr SHADWSK: $ss"
    echo -e "  ${OR}┌──────────────────────────────────────┐${NC}"
    echo -e "  ${OR}│${NC}  ${grenbo}1.${NC}${c11}SSH OVPN MANAGER${NC} ${grenbo}4.${NC}${c11}TROJAN MANAGER${NC}"
    echo -e "  ${OR}│${NC}  ${grenbo}2.${NC}${c11}VMESS MANAGER${NC}    ${grenbo}5.${NC}${c11}SHDWSK MANAGER${NC}"
    echo -e "  ${OR}│${NC}  ${grenbo}3.${NC}${c11}VLESS MANAGER${NC}    ${grenbo}6.${NC}${c11}OTHER SETTINGS${NC}"
    echo -e "  ${OR}└──────────────────────────────────────┘"
    echo -e "  ${grenbo}         Version script $versi${NC} "
    echo -e "           ${c1}━━━${c2}━━━${c3}━━━${c4}━━━${c5}━━━${c6}━━━${c7}━━${NC}"
    echo -e ""
    read -p "     Select From Options [ 1 - 6 ] : " menu
    case $menu in
        1) mssh ;;
        2) mvmess ;;
        3) mvless ;;
        4) mtrojan ;;
        5) mshadowsocks ;;
        6) msettings ;;
        *) echo ""; exit 0 ;;
    esac

    # التحقق كل 2 ثانية
    sleep 2
done
